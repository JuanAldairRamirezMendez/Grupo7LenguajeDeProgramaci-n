# Render service manifest for project
# This file configures services for the backend and the frontend (static) for Render.

services:
  - type: web_service
    name: descuentos-backend
    env: docker
    plan: starter
    # Path to Dockerfile inside repository
    dockerfilePath: project/backend/Dockerfile
    # Branch to auto-deploy from
    branch: main
    autoDeploy: true
    # Health check path
    healthCheckPath: /health
    instanceCount: 1
    envVars:
      # Secrets: set the following in Render Dashboard under 'Environment' -> 'Secrets' or via the UI
      - key: DATABASE_URL
        fromSecret: DATABASE_URL
      - key: SECRET_KEY
        fromSecret: SECRET_KEY
      - key: ALGORITHM
        fromSecret: ALGORITHM
      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        fromSecret: ACCESS_TOKEN_EXPIRE_MINUTES
      - key: FRONTEND_URL
        fromSecret: FRONTEND_URL

  - type: static
    name: descuentos-frontend
    env: static
    plan: free
    branch: main
    # Limpia lockfile/node_modules antes de instalar y evita optionalDependencies problem√°ticos
    buildCommand: "cd project/frontend && rm -rf node_modules package-lock.json || true && npm ci --no-optional && npm run build"
    publishPath: "project/frontend/dist"
    envVars:
      - key: VITE_API_URL
        value: "https://descuentos-backend.onrender.com"

# Notes:
# - On Render, create the secrets named above (DATABASE_URL, SECRET_KEY, etc.).
# - DATABASE_URL should be a production Postgres URL (e.g. postgresql://user:pass@host:5432/dbname) or a managed Postgres add-on.
# - If you want to use Render Postgres, provision a database and use the provided connection string as DATABASE_URL.
# - The Dockerfile in project/backend will be used to build the backend image.
